# Feed System API Documentation

## Обзор

Система ленты постов предоставляет полнофункциональный API для создания, просмотра, комментирования и взаимодействия с постами. Включает в себя систему лайков, просмотров, поиска и рекомендаций.

## API Endpoints

### Посты

#### GET /api/feed/posts/
Получить список всех опубликованных постов с пагинацией.

**Параметры запроса:**
- `page` - номер страницы (по умолчанию: 1)
- `page_size` - количество постов на странице (по умолчанию: 10, максимум: 50)
- `ordering` - сортировка (`-created_at`, `created_at`, `-likes_count`, `-views_count`)

**Ответ:**
```json
{
  "count": 100,
  "next": "http://localhost:8000/api/feed/posts/?page=2",
  "previous": null,
  "results": [
    {
      "id": "uuid",
      "title": "Заголовок поста",
      "content": "Содержание поста...",
      "image": "http://localhost:8000/media/post_images/image.jpg",
      "tags": ["тег1", "тег2"],
      "author": {
        "id": 1,
        "username": "user123",
        "full_name": "Имя Фамилия",
        "avatar": "http://localhost:8000/media/avatars/avatar.jpg"
      },
      "likes_count": 15,
      "comments_count": 8,
      "views_count": 120,
      "created_at": "2025-09-15T19:30:00Z",
      "is_liked": false
    }
  ]
}
```

#### POST /api/feed/posts/
Создать новый пост. **Требует авторизации.**

**Тело запроса:**
```json
{
  "title": "Заголовок поста",
  "content": "Содержание поста (до 4000 символов)",
  "image": "файл изображения (опционально)",
  "tags": ["тег1", "тег2"]
}
```

#### GET /api/feed/posts/{id}/
Получить детальную информацию о посте. Автоматически записывает просмотр.

#### PUT/PATCH /api/feed/posts/{id}/
Обновить пост. **Требует авторизации и права на редактирование.**

#### DELETE /api/feed/posts/{id}/
Удалить пост. **Требует авторизации и права на удаление.**

### Комментарии

#### GET /api/feed/posts/{post_id}/comments/
Получить комментарии к посту.

#### POST /api/feed/posts/{post_id}/comments/
Добавить комментарий к посту. **Требует авторизации.**

**Тело запроса:**
```json
{
  "content": "Текст комментария",
  "parent": "id родительского комментария (для ответов)"
}
```

#### GET/PUT/PATCH/DELETE /api/feed/comments/{id}/
Операции с конкретным комментарием.

### Лайки

#### POST /api/feed/posts/{post_id}/like/
Поставить лайк посту. **Требует авторизации.**

#### DELETE /api/feed/posts/{post_id}/like/
Убрать лайк с поста. **Требует авторизации.**

### Поиск

#### GET /api/feed/search/
Поиск постов по различным критериям.

**Параметры запроса:**
- `query` - поисковый запрос (поиск в заголовке и содержании)
- `tags` - теги для поиска (можно указать несколько)
- `author` - поиск по автору (username или full_name)
- `date_from` - дата начала периода (YYYY-MM-DD)
- `date_to` - дата окончания периода (YYYY-MM-DD)
- `ordering` - сортировка результатов

**Пример:**
```
GET /api/feed/search/?query=Django&tags=программирование&tags=веб-разработка&ordering=-likes_count
```

### Рекомендации

#### GET /api/feed/recommendations/
Получить персонализированные рекомендации постов. **Требует авторизации.**

### Посты пользователя

#### GET /api/feed/my-posts/
Получить посты текущего пользователя. **Требует авторизации.**

#### GET /api/feed/users/{user_id}/posts/
Получить посты конкретного пользователя. **Требует авторизации.**

## Рекомендательная система

### Алгоритм работы

Рекомендательная система использует гибридный подход, сочетающий несколько методов:

#### 1. Контентная фильтрация (вес: 40%)
- Анализирует теги постов, которые лайкал пользователь
- Рекомендует посты с похожими тегами
- Учитывает частоту взаимодействия с определенными тегами

#### 2. Коллаборативная фильтрация (вес: 30%)
- Находит пользователей с похожими интересами
- Использует коэффициент Жаккара для определения схожести
- Рекомендует посты, которые понравились похожим пользователям
- Требует минимум 2 общих лайка для определения схожести

#### 3. Популярность (вес: 20%)
- Рекомендует популярные посты за последнюю неделю
- Формула популярности: `лайки × 3 + комментарии × 2 + просмотры`
- Учитывает актуальность контента

#### 4. Новизна (вес: 10%)
- Добавляет новые посты для разнообразия
- Рекомендует посты, созданные за последние 24 часа
- Обеспечивает свежесть контента в ленте

### Особенности реализации

#### Исключения
- Не рекомендует посты самого пользователя
- Исключает уже просмотренные посты
- Фильтрует только опубликованные посты

#### Оптимизация
- Использует `select_related` для оптимизации запросов
- Кэширует вычисления счетчиков лайков, комментариев и просмотров
- Ограничивает количество рекомендаций (по умолчанию: 20)

#### Дополнительные функции

**Популярные теги:**
```python
engine = RecommendationEngine()
trending_tags = engine.get_trending_tags(days=7)
```

**Похожие посты:**
```python
similar_posts = engine.get_similar_posts(post, limit=5)
```

### Настройка весов

Веса алгоритмов можно настроить в классе `RecommendationEngine`:

```python
class RecommendationEngine:
    def __init__(self):
        self.content_weight = 0.4      # Контентная фильтрация
        self.collaborative_weight = 0.3 # Коллаборативная фильтрация
        self.popularity_weight = 0.2    # Популярность
        self.freshness_weight = 0.1     # Новизна
```

## Система просмотров

### Логика записи просмотров
- Просмотр записывается при GET запросе к детальной странице поста
- Дублирующие просмотры от одного пользователя/IP блокируются на 1 час
- Сохраняется информация о пользователе, IP-адресе и User-Agent
- Анонимные просмотры отслеживаются по IP-адресу

### Предотвращение накрутки
- Временное окно в 1 час между просмотрами
- Учет как авторизованных, так и анонимных пользователей
- Использование IP-адреса для анонимных пользователей

## Модели данных

### Post
- `id` - UUID (первичный ключ)
- `title` - заголовок (до 255 символов)
- `content` - содержание (до 4000 символов)
- `image` - изображение (опционально)
- `tags` - массив тегов (JSON)
- `author` - автор поста
- `is_published` - статус публикации
- `created_at`, `updated_at` - временные метки

### Comment
- Поддержка вложенных комментариев через поле `parent`
- Связь с постом и автором
- Временные метки создания и обновления

### Like
- Уникальная связь пользователь-пост
- Предотвращает дублирование лайков

### PostView
- Отслеживание просмотров с метаданными
- IP-адрес и User-Agent для аналитики

### PostRecommendation
- Хранение рекомендаций с оценкой релевантности
- Причина рекомендации для отладки

## Безопасность

### Авторизация
- Использует декоратор `@token_required`
- Проверка прав доступа для редактирования/удаления
- Только авторы могут изменять свои посты и комментарии

### Валидация
- Ограничение длины контента (4000 символов)
- Валидация тегов и других полей через сериализаторы
- Проверка существования связанных объектов

## Производительность

### Оптимизация запросов
- `select_related` для связанных объектов
- `annotate` для подсчета лайков, комментариев и просмотров
- Индексы на часто используемые поля

### Пагинация
- Настраиваемый размер страницы (по умолчанию: 10)
- Максимальный размер страницы: 50
- Эффективная пагинация для больших наборов данных

## Расширение функциональности

### Добавление новых типов рекомендаций
1. Создать новый метод в `RecommendationEngine`
2. Добавить вес для нового алгоритма
3. Интегрировать в метод `get_recommendations_for_user`

### Кэширование
Рекомендуется добавить кэширование для:
- Популярных постов
- Трендовых тегов
- Рекомендаций пользователей

### Аналитика
Система готова для интеграции с аналитическими инструментами:
- Данные о просмотрах
- Статистика взаимодействий
- Эффективность рекомендаций